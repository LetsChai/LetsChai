@(user: User)

<!DOCTYPE html>
<html>
<head>
    <title></title>

    <!--Buttons-->
    <link href="/assets/modern-buttons/css/m-buttons.css" rel="stylesheet" />

    <!-- Jcrop CSS -->
    <link href="/assets/stylesheets/jquery.Jcrop.css" rel="stylesheet" />

    <!-- Bootstrap CDN -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />

    <!--jQuery CDN-->
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

    <style>
        @sitewide.style()
        @header.style()
        @sidebar.style()

        .row {
            margin-left:0;
            margin-right:0;
        }
        #content {
            display:inline-block;
            width:100%;
            padding-top: 3%;
        }
        #first-timers {
            background: pink;
            border-radius: 10px;
            margin-bottom: 2%;
            margin-top: 2%;
            text-align:center;
            padding: 1% 2%;
        }
        .picture-upload {
            margin: 2% 0;
        }
        .preview-window {
            height: 200px;
            width: 200px;
            overflow: hidden;
            position: relative;
        }
        .picture-preview {
            width: 200px;
        }
        .picture-input {
            margin-top: 2%;
        }
        #upload {
            padding-right: 3%;
            padding-left: 3%;
        }
        canvas, #to-submit {
            display: none;
        }
    </style>
</head>
<body>

<!-- Bootstrap JS -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<!-- Jcrop JS-->
<script src="/assets/javascripts/jquery.Jcrop.min.js"></script>

<!--Page Header-->
@header.content()

<!-- Sidebar -->
@sidebar.content()

<!--First time users-->
@if(user.hasFlag(types.Flag.NO_PICTURES)) {
    <div class="row">
        <div class="col-md-8 col-sm-offset-2" id="first-timers">
            Upload atleast <strong class="lc-red">2 good pictures</strong> of yourself. Profiles with fake pictures don't get matches.
            So snap off a selfie and let's chai!
        </div>
    </div>
}

<div class="row"><div class="col-sm-offset-3 col-lg-7">
    @for((pic,i) <- user.getPictures().zipWithIndex) {
        @if(i%2 == 0) {
            <div class="row">
        }
        <div class="col-lg-6 picture-upload">
            <div class="preview-window">
                <img class="picture-preview" src="@pic" />
            </div>
            <input type="file" class="picture-input" accept="image/*" />
            <button class="delete-picture">Delete</button>
        </div>
        @if(i%2 == 1) {
            </div>
        }
    }

    <div class="row" id="button-row">
        <button id="upload" class="m-btn green">Save</button>
        <a href="profile"><button id="cancel" class="m-btn">Cancel</button></a>
    </div>
</div></div>

<!-- Image crop modal -->
<div class="modal fade" id="image-crop">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title" id="myModalLabel">Select an Area</h4>
            </div>
            <div class="modal-body">
                <img />
            </div>
            <div class="modal-footer">
                <button id="finish-crop" type="button" class="btn btn-default" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>

<canvas id="test-canvas" width="400" height="400"></canvas>

<form id="to-submit" method="post" action="editpictures">
    <input type="hidden" id="image0" name="image0" />
    <input type="hidden" id="image1" name="image1" />
    <input type="hidden" id="image2" name="image2" />
    <input type="hidden" id="image3" name="image3" />
</form>

<script>
    var canvas = document.getElementById('test-canvas');
    var context = canvas.getContext('2d');

    var jcrop_api;
    var current_preview;

    $(".picture-input").change(function() {
        if (this.files && this.files[0]) {
            var self = this;
            var reader = new FileReader();
            reader.onload = function (e) {
                current_preview = $(self).parent().find(".picture-preview");
                current_preview.attr('src', e.target.result);
                $("#image-crop img").attr('src', e.target.result);
                $("#image-crop img").Jcrop({
                    aspectRatio: 1,
                    minSize: [350, 350],
                    setSelect: [0, 0, 350, 350],
                    boxWidth: 500,
                    boxHeight: 500
                }, function () {
                    jcrop_api = this;
                });
                $("#image-crop").modal();
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    $("#finish-crop").click(function() {
        var previewSize = 200;

        var picHeight = $("#image-crop img")[0].naturalHeight;
        var picWidth = $("#image-crop img")[0].naturalWidth;

        coords = jcrop_api.tellSelect();
        var rx = previewSize / coords.w;
        var ry = previewSize / coords.h;

        current_preview.css({
            width: Math.round(rx * picWidth) + 'px',
            height: Math.round(ry * picHeight) + 'px',
            marginLeft: '-' + Math.round(rx * coords.x) + 'px',
            marginTop: '-' + Math.round(ry * coords.y) + 'px'
        });
        current_preview.parents(".picture-upload").find('.picture-input').data("coords", coords);
        jcrop_api.destroy();
        $("#image-crop img").attr('src', '');
    });

    $("#upload").click(function() {
        uploadFiles();
    });

    $(".delete-picture").click(function() {
        var INPUT = $(this).parents(".picture-upload").find(".picture-input");
        INPUT.wrap("<form>").parent("form").trigger("reset");
        INPUT.unwrap();
        INPUT.data("delete", true);
        $(this).closest(".picture-upload").find(".picture-preview").attr("src", "/assets/images/silhouette.png");
    });

    function uploadFiles () {
        var files = [];
        var inputs = $('.picture-input');
        inputs.each(function(i, input) {
            if (input.files && input.files[0]) {
                var base64image = cropResizeFile(input);
                $("#image" + i).val(base64image.substring(23));
            } else if ($(input).data("delete") == true) {
                $("#image" + i).val("delete");
            }
        });
        $("#to-submit").submit();
    }

    // requires input Element to have JCrop coordinates in data.coords
    // returns base64 encoded JPEG of compressed and cropped image
    function cropResizeFile (inputElement) {
        var coords = $(inputElement).data("coords");
        var imageElement = $(inputElement).parent().find(".picture-preview")[0];
        // canvas.clearRect(0, 0, 400, 400);
        context.drawImage(imageElement, coords.x, coords.y, coords.w, coords.h, 0, 0, 400, 400);
        return canvas.toDataURL("image/jpeg");
    }

</script>

</body>
</html>